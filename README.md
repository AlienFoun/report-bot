# Report Bot

# О проекте
**Программа позволяет создать инфрастуктуру для сдачи отчетов через Telegram-бота**


# Структура проекта
Проект структурирован для лучшего масштабирования. В целом, имена файлов отражают их суть
* main - содержит код основного бота, которому пользователи сдают отчет
* bot_config - содержит необходимую информацию для работы основного бота
* admin_bot_config - содержит необходимую информацию для работы бота администратора
* sql_config - содержит необходимую информацию для работы с PostgreSQL
* admin_bot - содержит код бота администратора
* helper - содержит функции, необходимые для работы основного бота
* sql_funcs - содержит функции, необходимые для работы с PostgreSQL
* models - содержит модели для базы данных
* keyboards - содержит клавиатуры для Telegram
* unittests - содержит автоматические тесты работоспособности функций бота

# Выбранные библиотеки
* Aiogram - Библиотека для работы с работы с API Telegram
* Psycopg2 - Библиотека для работы с базой данных PostgreSQL
* APScheduler - Библиотека для выполнения задач в определенное время
* Pygsheets - Библиотека для работы с Google-Sheets
* Peewee - Библиотека для работы с базой данных через ORM

# Установка
Загрузить python 3.8 или выше

```
git clone https://gitlab.com/proxylab/hr/reports/matvei-alienfoun/report_bot
cd report_bot

Для pip: pip install -r requirements.txt

Для poetry:
  poetry install
  poetry update
```

Заполните данные для запуска основного бота в файле `bot_config.py`.

```python
BOT_TOKEN = 'your_token'
```

Заполните данные для запуска бота администратора в файле `admin_bot_config.py`. Так же укажите id чата, в который будут приходить уведомления

```python
ADMIN_BOT_TOKEN = 'your_token'
ADMIN_CHAT_ID = your_chat_id
```

Заполните данные для подключения к PostgreSQL в файле `sql_config.py`.

```python
host = 'your_host'
user = 'your_user'
password = 'your_password'
db_name = 'your_database'
```

Для того, чтобы использовать бота с интеграцией с Google Sheets, вам необходимо создать файл service.json. Инструкция по созданию сервисного аккаунта: [ссылка](https://pygsheets.readthedocs.io/en/stable/authorization.html#)

После выполнения инструкции, вам будет необходимо переименовать файл в service.json и поместить в папку с ботом

# Использование

Откройте терминал, перейдите в папку с проектом и запустите ботов, используя команды:
* Для запуска основного бота `python main.py`.
* Для запуска бота администратора `python admin_bot.py`.

# Работа с базой данных

Взаимодействие с базой данных осуществляется при помощи библиотеки Peewee с помощью функций из модуля `models`

Подключение к базе данных PostgreSQL:

```python
db = PostgresqlDatabase(
	host=host,
	user=user,
	password=password,
	database=db_name,
	autocommit=autocommit
)
```

Все функций выполняются при помощи запросов при помощи ORM.

В начале создается базовая модель таблиц, при помощи которой будут создаваться последующие таблицы:

```python
class BaseModel(Model):
	id = PrimaryKeyField(unique=True)

	class Meta:
		database = db
		order_by = 'id'
```

Пример модели таблицы с отчетами пользователей:

```python
class UserBase(BaseModel):
	user_id = BigIntegerField()
	time1 = TextField()
	time2 = TextField()
	time3 = TextField()
	time4 = TextField()
	isreporttoday = TextField()
	user_name = TextField()

	class Meta:
		db_table = 'user_base'
```

Как пример, функция получения информации о user_id пользователей, не сдавших отчет вовремя

```python
def add_report(user_id: int, date: str, text: str, time: str):
    """
    Функция добавляет в базу данных отчет пользователя
        Параметры:
            user_id (int): Telegram-id пользователя
            date (str): Дата, за которую оставлен отчет
            text (str): Текст отчета
            time (str): Время, потраченое на выполнение отчета
    """
    UserReport.create(user_id=user_id, report_date=date, report_text=text, report_time=time)
```
Вся информация отправляется в базу данных в исходном виде, кроме даты отчета, который переводится в формат 06.05.2022

# Как это работает?

## Старт

После запуска, бот будет доступен в Телеграм. Вы сможете присылать сообщение в диалог с ботом.

Во время запуска, бот получит информацию из базы данных о времени, до которого необходимо сдать отчет, однако если такой информации нет в базе данных, будет возвращено стандартное время, а именно 19:00. Стандартное время будет также записано в базу данных

```python
def get_report_time() -> str:
    """
    Функция-буфер, которая проверяет, есть ли информация о времени, до которого необходимо сдать отчет в базе данных
    В случае отсутствия такового, устанавливает его на стандартное значение - 19:00 и возвращает его
    В случае, если время есть в базе данных, то возвращает значение из базы
        Возвращаемое значение:
            report_time (str): Время, до которого необходимо сдать отчет
    """
	try:
		rows = AdminConfig.get()
	except:
		rows = ()

	if rows != ():
		return rows.report_time
	AdminConfig.create(report_time='19:00')
	return '19:00'
```

В планировщик (schedule) будут добавлены задачи на восстановление уведомлений для пользователей, которые еще не отправили отчет в текущий день в то время, до которого необходимо загрузить отчет. Это время можно изменить при помощи Админ бота, однако в виду особенностей работы бота, оно будет изменено лишь после 00:00

```python
def return_report_param():
    """
    Функция изменяет время запуска функции запуска уведомлений в соответствии со значением из базы данных
    """
    report_time = SQLfuncs.get_report_time()
    # report_time = '19:00'
    hour, minute = report_time_converter(report_time)
    trigger = CronTrigger(hour=hour, minute=minute)
    scheduler.modify_job('resume_notify', trigger=trigger)
    SQLfuncs.set_default_report()
```

Во время выполнения задачи на восстановление уведомлений, бот получит из базы список пользователей, которые еще не оставили отчет на текущий день и восстановит им задачи на получение уведомлений

```python
def resume_notify():
    """
    Функция для запуска напоминаний, если отчет не был заполнен вовремя
    """	
    user_ids = SQLfuncs.check_report()
	for user in user_ids:
		for job in range(4):
			scheduler.get_job(f'{user.user_id}-{emoji_tuple[job]}').resume()
```

Также будет добавлена задача сброса в 00:00 информации о том, что пользователь отправил отчет за текущий день. А также будет получен список пользователей бота и им будут проставлены задачи на уведомление в выбранное пользователями время

Доступные команды: 
```
/start - Начать взаимодействие с ботом
```

После того, как боту придет команда /start, бот проверит, есть ли текущий пользователь в базе данных. 

```python
def check_user(user_id: int) -> bool:
    """
    Функция проверяет, находится ли пользователь в базе данных на данный момент
        Параметры:
            user_id (int): Telegram-id пользователя
        Возвращаемое значение:
            True/False (bool): Информация о том, находится ли пользователь в базе данных
    """
    rows = UserBase.select(UserBase.user_id).where(UserBase.user_id == user_id)
	for row in rows:
		if user_id == row.user_id:
			return True
	return False
```

Если он находится в базе данных, ему будет предложено выбрать одно из действий на клавиатуре:
* Составить отчет!
* Посмотреть прошлые отчеты
* Изменить время для уведомлений

Иначе пользователь будет автоматически добавлен в базу данных бота и ему будут присвоены стандартные значения времени уведомлений:
* 20:00
* 22:00
* 07:00
* 09:00

А также пользователю будет предложено установить свое имя пользователя, которое позже будет отображаться в его отчетах

Также в планировщик будут добавлены задачи на отправку уведомлений для этого пользователя

## Создать отчет!

После выбора действия "Составить отчет", пользователю будет предложено ввести дату отчета, которая будет приведена к формату 06.05.2022

```python
def date_converter(date: str) -> str:
    """
    Преобразует входящую дату из любого формата (6.5.22, 06.05.22, 6.5.2022, 06.05.2022, 6.5) в формат 06.05.2022
        Параметры:
            date (str): дата исходного формата
        Возвращаемое значение:
            current_date (str): дата, преобразованная в конечный формат
    """
    current_year = datetime.datetime.today().year
	splited_date = date.split('.')
	if len(splited_date) == 2:
		splited_date.append(str(current_year))
	splited_date[-1] = splited_date[-1] if len(splited_date[-1]) == 4 else f'20{splited_date[-1]}'
	int_date = list(map(int, splited_date))
	current_date = datetime.date(int_date[2], int_date[1], int_date[0]).strftime('%d.%m.%Y')
	return current_date
```

После этого, дата будет записана в машину состояний и бот попросит пользователя ввести текст отчета, который можно ввести в свободной форме

После этого, текст будет записан в машину состояний и бот попросит пользователя ввести информацию о том, сколько времени потребовалось на выполнение перечисленного в отчете в часах

После того, как пользователь введет значение, бот отправит пользователю введенную им информацию и уточнит, подтверждает ли пользователь отправление отчета

```
Ваш отчет:
Дата: 06.05.2022
Текст: Проверка работоспособности бота.
Затраченное время (в часах): 3часа
```

После подтверждения пользователем, информация из машины состояний будет записана в базу данных, продублирована в гугл таблице, а так же уведомление о том, что пользователь отправил отчет будет отправлено в Админ бот с полной информацией об отчете

```
Пользователь user_id оставил отчет:
Дата: 06.05.2022
Текст: Проверка работоспособности бота.
Затраченное время (в часах): 3.0
```

Информация о затраченном времени будет приведена к формату вещественного числа при помощи функции

```python
def time_converter(time: str) -> float:
    """
    Преобразует входящую время из любого формата (8ч, 8часов, 8 часов, 8,3 часов, 8, 8,3, 8) в формат 8.0
        Параметры:
            time (str): время исходного формата
        Возвращаемое значение:
            curr_digits (float): время, преобразованное в конечный формат
    """
    curr_time = time.replace(',', '.')
    time_list = curr_time.split()[0]
    digits = re.match('[.0-9]+', time_list)[0]
    curr_digits = float(digits)
    return curr_digits
```
Пользователь в любой момент может вернуться на предыдущий шаг или посмотреть введенную ранее информацию при помощи кнопок на клавиатуре Telegram.

После отправки отчета, пользователю будут приостановлены уведомления на текущий день, а так же в базу будет записана информация о том, что пользователь сдал отчет.

## Посмотреть прошлые отчеты

После выбора действия "Посмотреть прошлые отчеты", пользователю будет выведено сообщение, что раздел еще находится в разработке

## Изменить время для уведомлений

После выбора действия "Изменить время для уведомлений", пользователю будет предложено выбрать время для уведомлений, которое он хочет изменить. 

После этого, пользователю будет предложено ввести новое время для уведомлений в формате чч:мм

После того, как будет введено время, бот спросит у пользователя, подтверждает ли он изменение времени для уведомлений

```
Вы изменили время на 18:04. Подтвердить время?
```

В случае положительного ответа, будет изменено время для уведомлений как в самом боте (чтобы уведомление пришло вовремя), так и в базе данных.

В Админ бот будет направлено уведомление с информацией о старом и новом времени для уведомлений у пользователя. Пример уведомления:

```
Пользователь user_id изменил время для уведомлений:
Старое время для уведомлений: 22:00
Новое время для уведомлений: 18:04
```
